function buildMap(e){this.map=new OpenLayers.Map(e,{controls:[]}),cache.mapDivId=e}function cityArea(e){this.map=e.map}function DistanceTool(e){this.map=e.map}function drawTool(e){this.map=e.map}function mapControl(e){this.map=e.map}function mapShape(e){this.map=e.map}function picLayer(e){this.map=e.map}buildMap.prototype={createMap:function(){var e=this.map,t=new OpenLayers.Layer.WMS("basicMap",mapStyle.wmsUrl,{layers:mapStyle.wmsName},{});mapStyle.mapDrag&&e.addControl(new OpenLayers.Control.Navigation({documentDrag:!0})),e.addLayer(t),e.setCenter(new OpenLayers.LonLat(mapStyle.mapLon,mapStyle.mapLat),mapStyle.mapZoom),this.mapWms=t},moveTo:function(e,t,a){this.map.setCenter(new OpenLayers.LonLat(e,t),a)},getMap:function(){return this.map},refreshUrl:function(e){this.mapWms.url=e,this.mapWms.redraw()},addEventToLayers:function(e,t){var a=new OpenLayers.Control.SelectFeature(e,{hover:!0,highlightOnly:selectStyle.highlightOnly,onSelect:function(e){var a={};a.type="onSelect",a.feature=e,t(a)},onUnselect:function(e){var a={};a.type="onUnselect",a.feature=e,t(a)},callbacks:{click:function(e){if(t){var a={};a.type="click",a.feature=e,t(a)}}}});this.map.addControls([a]),a.activate(),this.layerEvent=a},deactivateEvent:function(){this.layerEvent.deactivate()},activateEvent:function(){this.layerEvent.activate()}};var cache={mapDivId:""};cityArea.prototype={loadCity:function(e,t,a){this.featureType?(this.featureType=null,this.loadJsonDatas(e,"country")):"city"!==e&&this.loadJsonDatas(e,"city"),this.areaLayer&&this.areaLayer.removeAllFeatures();var r="";if(this.areaLayer)r=this.areaLayer;else{var n=this.map.getLayersByName("areaLayers");this.layerObj=n,r=selectStyle.fontShow?new OpenLayers.Layer.Vector("areaLayers",{styleMap:new OpenLayers.StyleMap({"default":{fillColor:"${color}",label:"${areaname}",fillOpacity:mapStyle.fillOpacity,strokeColor:mapStyle.strokeColor,strokeWidth:mapStyle.strokeWidth,fontFamily:"宋体",fontSize:mapStyle.fontSize,fontColor:mapStyle.fontColor,labelOutlineWidth:mapStyle.labelOutlineWidth,labelOutlineColor:mapStyle.labelOutlineColor},select:{fillColor:selectStyle.fillColor,label:"${key}",fillOpacity:selectStyle.fillOpacity,strokeColor:selectStyle.strokeColor,strokeWidth:selectStyle.strokeWidth,cursor:selectStyle.cursor}})}):new OpenLayers.Layer.Vector("areaLayers",{styleMap:new OpenLayers.StyleMap({"default":{fillColor:"${color}",label:"${areaname}",fillOpacity:mapStyle.fillOpacity,strokeColor:mapStyle.strokeColor,strokeWidth:mapStyle.strokeWidth,fontFamily:"宋体",fontSize:mapStyle.fontSize,fontColor:mapStyle.fontColor,labelOutlineWidth:mapStyle.labelOutlineWidth,labelOutlineColor:mapStyle.labelOutlineColor},select:{fillColor:selectStyle.fillColor,label:"",fillOpacity:selectStyle.fillOpacity,strokeColor:selectStyle.strokeColor,strokeWidth:selectStyle.strokeWidth,cursor:selectStyle.cursor}})}),this.map.addLayers([r])}var i=new OpenLayers.Format.GeoJSON,o=this.areaJson;for(var l in o){var s=new Object({}),y=o[l];if(s.key=y.name,s.parentName=y.parentName,s.type="area",mapStyle.fontShow?s.areaname=y.name:s.areaname="",t)for(var p in t){if(t[p].name===s.key){s.color=t[p].color,selectStyle.defaultFont&&(s.areaname=t[p].name);break}s.color=mapStyle.fillColor}else s.color=mapStyle.fillColor;y.properties=s,"undefined"!=typeof a&&y.name!==a||(r.addFeatures(i.read(y)),this.areaLayer=r)}},loadCountry:function(e,t,a){this.featureType="country",this.loadCity(e,t,a)},load21City:function(e){var t=[],a=gd21City.features;for(var r in a)t.push(a[r]);this.areaJson=t,this.loadCity("city",e)},load86Country:function(e){var t=[],a=gd86Country.features;for(var r in a)t.push(a[r]);this.areaJson=t,this.loadCity("city",e)},load98Country:function(){},loadTargetArea:function(e){var t=[],a=gd86Country.features;for(var r in a)a[r].parentName===e&&t.push(a[r]);this.areaJson=t,this.loadCity("city")},loadJsonDatas:function(e,t){var a=[],r=[],n=e.split(",");if("city"===t){r=gd21City.features;for(var i in r)for(var o in n)if(r[i].name===n[o]){a.push(r[i]);break}}else{r=gd86Country.features;for(var l in r)for(var s in n)r[l].parentName===n[s]&&a.push(r[l])}this.areaJson=a},addSelectEvent:function(e,t){var a=document.getElementById(cache.mapDivId),r=this.areaLayer;this.map.events.register("mousemove",this.map,function(e){var t=document.getElementById("showLayer");if(t){var r=t.offsetWidth,n=t.offsetHeight,i=a.offsetWidth,o=a.offsetHeight,l=a.offsetTop,s=a.offsetLeft,y=e.offsetY+l,p=e.offsetX+s;e.offsetX+r+10>i&&(p-=r+20),e.offsetY+n+10>o&&(y-=n+20),t.style.top=y+10+"px",t.style.left=p+10+"px"}});var n=r.features;for(var i in n)for(var o in e)e[o].name===n[i].attributes.key&&(n[i].attributes.html=e[o].content);var l=new OpenLayers.Control.SelectFeature([r],{hover:!0,highlightOnly:selectStyle.highlightOnly,onSelect:function(e){var t=e.attributes.html;t||(t="");var a=document.getElementById("showLayer");a&&a.parentNode.removeChild(a);var r=document.createElement("div");r.setAttribute("id","showLayer"),r.style.width="auto",r.style.height="auto",r.style.position="absolute",r.style.zIndex="999",r.innerHTML=t,document.getElementById(cache.mapDivId).appendChild(r)},onUnselect:function(e){document.getElementById("showLayer").style.display="none"},callbacks:{click:function(e){function a(){return t(e.attributes.key)}t&&a(t)}}});this.map.addControls([l]),l.activate(),this.layerEvent=l},getLayer:function(){return this.areaLayer}},DistanceTool.prototype={addDistanceTool:function(){var e={label:"",strokeColor:"green",strokeOpacity:1,strokeWidth:2,pointRadius:6},t=new OpenLayers.Layer.Vector("Path",{styleMap:new OpenLayers.StyleMap({"default":{fillColor:"red",fillOpacity:"0.6",strokeColor:"green",strokeWidth:"2"}})}),a={line:new OpenLayers.Control.DrawFeature(t,OpenLayers.Handler.Path,{handlerOptions:e,featureAdded:function(e){console.info("finished")},callbacks:function(e){console.info(e)}})},r=a.line,n="",i="",o=0;r.handler.callbacks.point=function(e){if(""!==n){var t=OpenLayers.Util.distVincenty({lon:n,lat:i},{lon:e.x,lat:e.y});console.log(t+o),n=e.x,i=e.y,o+=t}else n=e.x,i=e.y},this.map.addControl(r),r.activate(),this.map.addLayer(t);var l=new(OpenLayers.Class(OpenLayers.Control,{initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]),this.layer=e,this.handler=new OpenLayers.Handler.Feature(this,e,{dblclick:this.dbClickFeature,click:this.clickFeature})},dbClickFeature:function(e){console.info("dbClick")},clickFeature:function(e){console.info("click2")}}))(t);this.map.addControl(l),l.activate(),this.polygon=r},removeDistanceTool:function(){this.polygon&&this.polygon.deactivate()}},drawTool.prototype={drawPolygon:function(){var e={label:"",labelXOffset:"70",labelYOffset:"-12",strokeColor:"#FF0000",strokeOpacity:1,strokeWidth:2,fillColor:"#FF0000",fillOpacity:.5,pointRadius:6},t=new OpenLayers.Layer.Vector("Polygon",{styleMap:new OpenLayers.StyleMap({"default":{fillColor:"red",fillOpacity:"0.6",strokeColor:"blue",strokeWidth:"1"}})});this.initDraw(e,t,"Polygon"),this.polygonLayer=t},drawPath:function(){var e={label:"",strokeColor:"green",strokeOpacity:1,strokeWidth:2,pointRadius:6},t=new OpenLayers.Layer.Vector("Path",{styleMap:new OpenLayers.StyleMap({"default":{fillColor:"red",fillOpacity:"0.6",strokeColor:"green",strokeWidth:"2"}})});this.initDraw(e,t,"LineString"),this.pathLayer=t},drawPoint:function(){var e={strokeColor:"green",strokeOpacity:1,strokeWidth:2,labelXOffset:"70",labelYOffset:"-12",pointRadius:6,label:"${key}"},t=OpenLayers.Util.applyDefaults({graphicWidth:35,graphicHeight:46,graphicYOffset:-38,graphicOpacity:1,externalGraphic:"marker.png",strokeColor:"blue",strokeWidth:3,strokeOpacity:.5,label:"${getLabel}"},OpenLayers.Feature.Vector.style["default"]),a=OpenLayers.Util.applyDefaults({labelXOffset:70,labelYOffset:-12,pointRadius:6,label:"点击地图进行标记",strokeWidth:3,strokeColor:"red",graphicName:"square"},OpenLayers.Feature.Vector.style.temporary),r=new OpenLayers.StyleMap({"default":new OpenLayers.Style(t,{context:{getLabel:function(e){return e.attributes.key}}}),temporary:new OpenLayers.Style(a)}),n=new OpenLayers.Layer.Vector("Point",{styleMap:r});this.initDraw(e,n,"Point"),this.pointLayer=n},drawRegularPoygon:function(e){var t="";"triange"===e?t="3":"square"===e?t="4":"pentagon"===e?t="5":"hexagon"===e?t="6":"circle"===e&&(t="50");var a={fillColor:"red",fillOpacity:"0",strokeColor:"green",strokeOpacity:"0",strokeWidth:"0",label:"点击地图进行拖动",labelXOffset:"70",labelYOffset:"-12",sides:t,irregular:!0},r=new OpenLayers.Layer.Vector("RegularPolygon",{styleMap:new OpenLayers.StyleMap({"default":{fillColor:"red",fillOpacity:"0.6",strokeColor:"blue",strokeWidth:"1"}})});this.initDraw(a,r,"RegularPolygon"),this.regularPlygonLayer=r},initDraw:function(e,t,a){var r={point:new OpenLayers.Control.DrawFeature(t,OpenLayers.Handler.Point,{handlerOptions:e,featureAdded:function(e){console.info("finished"),e.attributes={key:"llllll"},n.handlerOptions.label="",o.activate(),l.deactivate();var t=new OpenLayers.LonLat(e.geometry.x,e.geometry.y),a=this.map.getPixelFromLonLat(t),r=document.createElement("div");r.setAttribute("id","pointText"),r.style.width="auto",r.style.height="auto",r.style.position="absolute",r.style.left=a.x,r.style.top=a.y+25,r.style.zIndex="999",r.innerHTML="<div>输入名称<input id='textVal' type='text'><input id='textSure' type='button' value='确定'/></div>",document.body.appendChild(r);var i=document.getElementById("textSure");i&&(i.onclick=function(){var t=document.getElementById("pointText");if(t){var a=document.getElementById("textVal").value;e.attributes={key:a},t.parentNode.removeChild(t)}})}}),line:new OpenLayers.Control.DrawFeature(t,OpenLayers.Handler.Path,{handlerOptions:e,featureAdded:function(e){console.info("finished"),n.handlerOptions.label="",o.activate(),l.deactivate()}}),polygon:new OpenLayers.Control.DrawFeature(t,OpenLayers.Handler.Polygon,{handlerOptions:e,featureAdded:function(e){console.info("finished"),n.handlerOptions.label="",o.activate(),l.deactivate()}}),RegularPolygon:new OpenLayers.Control.DrawFeature(t,OpenLayers.Handler.RegularPolygon,{handlerOptions:e,featureAdded:function(e){console.info("finished"),n.handlerOptions.label="",o.activate(),l.deactivate()}})},n="";"Polygon"===a?n=r.polygon:"LineString"===a?n=r.line:"Point"===a?n=r.point:"RegularPolygon"===a&&(n=r.RegularPolygon),n.handler.callbacks.point=function(e){console.log(e)},this.map.addControl(n),n.activate(),this.map.addControl(n),n.activate(),this.map.addLayer(t);var i="OpenLayers.Geometry."+a;"RegularPolygon"===a&&(i="OpenLayers.Geometry.Polygon");var o=new OpenLayers.Control.DragFeature(t,{geometryTypes:[i],onEnter:function(e){console.info("enter"),l.activate(),n.handlerOptions.label="双击删除"},onLeave:function(e){console.info("out"),n.handlerOptions.label=""}});this.map.addControl(o),o.activate();var l=new(OpenLayers.Class(OpenLayers.Control,{initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]),this.layer=e,this.handler=new OpenLayers.Handler.Feature(this,e,{dblclick:this.dbClickFeature,click:this.clickFeature})},dbClickFeature:function(e){console.info("dbClick"),t.removeFeatures([e]),o.deactivate(),l.activate(),n.handlerOptions.label=""},clickFeature:function(e){console.info("click2")}}))(t);this.map.addControl(l),l.activate()},clearDraw:function(e){e?"point"===e?this.map.removeLayer(this.pointLayer):"path"===e?this.map.removeLayer(this.pathLayer):"plygon"===e?this.map.removeLayer(this.polygonLayer):"regularPlygon"===e&&this.map.removeLayer(this.regularPlygonLayer):(this.pointLayer&&this.map.removeLayer(this.pointLayer),this.pathLayer&&this.map.removeLayer(this.pathLayer),this.polygonLayer&&this.map.removeLayer(this.polygonLayer),this.regularPlygonLayer&&this.map.removeLayer(this.regularPlygonLayer))}},mapControl.prototype={addLoadingPanel:function(){this.map.addControl(new OpenLayers.Control.LoadingPanel)},addZoomBar:function(){this.map.addControl(new OpenLayers.Control.PanZoomBar)},addViewMap:function(){this.map.addControl(new OpenLayers.Control.OverviewMap)},addPosition:function(){this.map.addControl(new OpenLayers.Control.MousePosition)},addLayerSwitcher:function(){this.map.addControl(new OpenLayers.Control.LayerSwitcher)}},mapShape.prototype={addPoints:function(e){var t=new OpenLayers.Rule({filter:new OpenLayers.Filter.Function({evaluate:function(e){return e}}),symbolizer:{externalGraphic:"${imgPath}",label:"${text}",labelXOffset:"15",labelYOffset:"10",cursor:"pointer",graphicWidth:"${width}",graphicHeight:"${height}",graphicOpacity:1}}),a=new OpenLayers.Style;a.addRules([t]);var r=this.map.getLayersByName("player");r.length>0&&this.map.removeLayer(r);var n=new OpenLayers.Layer.Vector("player");n.styleMap=new OpenLayers.StyleMap(a),this.map.addLayer(n);var i=[];for(var o in e){var l=e[o],s=new OpenLayers.Geometry.Point(l.lon,l.lat),y=new OpenLayers.Feature.Vector(s),p=l.text;p||(p=""),y.attributes={imgPath:l.img,key:l.name,text:p,width:l.imgWidth,height:l.imgHeight,type:"point",pointKind:l.type},i.push(y)}n.addFeatures(i),this.pointLayer=n,this.pointList=i},addPointsEvent:function(e,t){var a=this.pointLayer;this.map.events.register("mousemove",this.map,function(e){var t=document.getElementById("showLayer");t&&(t.style.top=e.pageY+10,t.style.left=e.pageX+10)});var r=a.features;for(var n in r)for(var i in e)e[i].name===r[n].attributes.key&&(r[n].attributes.html=e[i].content);var o=new OpenLayers.Control.SelectFeature([a],{hover:!0,onSelect:function(e){var r=e.attributes.html;r||(r="");var n=document.getElementById("showLayer");n&&n.parentNode.removeChild(n);var i=document.createElement("div");if(i.setAttribute("id","showLayer"),i.style.width="auto",i.style.height="auto",i.style.position="absolute",i.style.zIndex="999",i.innerHTML=r,document.body.appendChild(i),"point"===e.attributes.type&&pointSelectStyle.status&&(e.attributes.width=parseInt(e.attributes.width)+parseInt(15),e.attributes.height=parseInt(e.attributes.height)+parseInt(15),a.redraw()),t){var o={};o.type="onSelect",o.ele=e,t(o)}},onUnselect:function(e){if("point"===e.attributes.type&&pointSelectStyle.status&&(e.attributes.width=parseInt(e.attributes.width)-parseInt(15),e.attributes.height=parseInt(e.attributes.height)-parseInt(15),a.redraw()),document.getElementById("showLayer").style.display="none",t){var r={};r.type="onUnselect",r.ele=e,t(r)}},callbacks:{click:function(e){if(t){var a={};a.type="click",a.ele=e,t(a)}}}});console.info(this.map),this.map.addControls([o]),o.activate()},hidePoint:function(e){var t=this.pointLayer.features,a=[];for(var r in t){var n=t[r];for(var i in e)n.attributes.pointKind===e[i]&&a.push(n)}this.pointLayer.removeFeatures(a)},showPoint:function(e){var t=this.pointList,a=[];for(var r in t){var n=t[r];for(var i in e)n.attributes.pointKind===e[i]&&a.push(n)}this.pointLayer.addFeatures(a)},addMarkers:function(e){var t=new OpenLayers.Layer.Markers("Markers");this.map.addLayer(t);for(var a in e){var r=new OpenLayers.Size(e[a].imgWidth,e[a].imgHeight),n=new OpenLayers.Pixel(-(r.w/2),-r.h),i=new OpenLayers.Icon(e[a].img,r,n);t.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(e[a].lon,e[a].lat),i))}this.markers=t},addMarkersEvent:function(e){},getLayer:function(){return this.pointLayer}},picLayer.prototype={addWms:function(e,t,a){var r=(this.map.layers.length,new OpenLayers.Layer.WMS(e,t,a,{singleTile:!0,ratio:1,transparent:!0}));this.map.addLayer(r),this.picWms=r},setWmsZIndex:function(e){this.map.setLayerIndex(this.picWms,e)},refreshWms:function(e,t){this.map.getLayersByName(e)[0].mergeNewParams(t)},setWmsShow:function(e,t){this.map.getLayersByName(e)[0].setVisibility(t)},addImage:function(e,t){var a=this.map.getProjectionObject(),r=new OpenLayers.Bounds(t);r=r.transform("EPSG:4326",a);var n=new OpenLayers.Layer.Image("tempImage",e,r,r.getSize(),{transparent:!0,isBaseLayer:!1});this.map.addLayers([n]),picLayer.tempImage=n},showImage:function(){picLayer.tempImage.setVisibility(!0)},hideImage:function(){picLayer.tempImage.setVisibility(!1)},refreshImage:function(e){picLayer.tempImage.url=e,picLayer.tempImage.redraw()},animateImage:function(e,t){if(picLayer.animateModel){picLayer.lastIndex=t;var a=window.setTimeout(function(){picLayer.prototype.refreshImage(e[t]),picLayer.animateModel&&t===e.length-1&&(t=0),t<e.length-1&&picLayer.prototype.animateImage(e,t+1)},picLayer.animateTime);picLayer.animateControl=a}},startImageAnimate:function(e,t,a){picLayer.animateModel=a,picLayer.animateList=e,picLayer.animateTime=t,picLayer.prototype.animateImage(e,0)},stopImageAnimate:function(){"undefined"!=typeof picLayer.animateModel&&(picLayer.animateModel=!1)},goOnImageAnimate:function(){picLayer.animateModel=!0,picLayer.prototype.animateImage(picLayer.animateList,picLayer.lastIndex+1)},changeAnimateTime:function(e){picLayer.animateTime=e}};